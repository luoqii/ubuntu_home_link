/* Copyright (C) 2006-2016 Michel Gutierrez <mig@downloadhelper.net>
 * All Rights Reserved
 * 
 * If you are interested in methods used in this project, follow the
 * open source project at https://github.com/mi-g/fang
 */

function UpdateExtensions(){extensions={},simplePrefs.prefs["media-extensions"].split("|").forEach(function(e){extensions[e]=1})}function UpdateFilterOut(){filterOutRE=null;var e=simplePrefs.prefs["network-filter-out"];if(e)try{filterOutRE=new RegExp(e,"i")}catch(t){}}function GetRespHeader(e,t){var r=null;try{r=e.getResponseHeader(t)}catch(n){}return r}function GetReqHeader(e,t){var r=null;try{r=e.getRequestHeader(t)}catch(n){}return r}function WorkerForContent(e,t,r,n,s,i){var a;try{a=Worker({window:e.top?e.top:e,contentScriptFile:self.data.url("pagedata-content.js")})}catch(o){return void console.warn("Exception creating worker:",o.message)}a.port.on("pageurl",function(){try{a.port.emit("get-title",{specs:[s.spec]})}catch(e){if(a.tab){var r=/([^\/]*?)(?:\?.*)?$/.exec(a.tab.url)[1];t.title=r||_("media"),t.pageUrl=t.url,t.topUrl=t.pageUrl,t.isPrivate=privateBrowsing.isPrivate(a),NotifyHit(t)}a.detach()}}),a.port.on("pagedata",function(e){if(simplePrefs.prefs["smartnamer.enabled"]&&(t.title=e.title||_("media")),t.pageUrl=e.url,t.topUrl=i,t.isPrivate=privateBrowsing.isPrivate(a),a.tab){{viewFor(a.tab)}try{e10sEnabled||(t.thumbnail=a.tab.getThumbnail())}catch(s){}t.topUrl=a.tab.url}r?tbvws.handleNetworkHook(r,t):n?n.handleHit(t):NotifyHit(t),a.detach()})}function ListenResponse(e){var t=e.subject.QueryInterface(Ci.nsIHttpChannel),r=tbvws.networkHook(t.name),n=!!r,s=GetRespHeader(t,"Content-Length");if(n||"0"!==s){var i=null,a=GetRespHeader(t,"Content-Range");if(a){var o=RANGE_PATTERN.exec(a);o&&(i=o[1])}i||(i=s),i=parseInt(i);var l=EXT_PATTERN.exec(t.name),p=null;if(l){if(p=l[1].toLowerCase(),"m4s"==p&&simplePrefs.prefs["dash.hide-m4s"])return;if("ts"==p&&simplePrefs.prefs["mpegts.hide-ts"])return;if("f4f"==p)return;extensions[l[1]]||(l=null)}var c=GetRespHeader(t,"Content-Type"),u=TYPE_PATTERN.exec(c),f=null;if(n||(f=chunks.networkHook(t,{contentType:c}),n=!!f),!(simplePrefs.prefs["tbvws.hide-dash"]&&TBVWS_DASH_SEG_PATTERN.test(t.name)||!n&&filterOutRE&&filterOutRE.test(t.name)||!n&&!u&&isNaN(i)&&!l||!(n||u||l)&&(0==simplePrefs.prefs["mediaweight-threshold"]||i<simplePrefs.prefs["mediaweight-threshold"])||!n&&!isNaN(i)&&i<simplePrefs.prefs["mediaweight-min-size"]||!n&&filterOutRE&&filterOutRE.test(t.name)||!n&&u&&"ms-asf"==u[2]&&simplePrefs.prefs["exclude-msasf"]||!n&&u&&"f4f"==u[2].toLowerCase())){var d={id:"network-probe:"+utils.md5(t.name),url:t.name},m=GetRespHeader(t,"Content-Disposition");if(m){var v=CDFNAME_PATTERN.exec(m);v&&v[1]&&(d.headerFilename=v[1])}var h={},R={visitHeader:function(e,t){h[e]=t}};if(t.visitRequestHeaders(R),simplePrefs.prefs["remove-media-no-cache"]){var E=GetRespHeader(t,"Pragma");"no-cache"==E&&t.setResponseHeader("Pragma",null,!1);var w=GetRespHeader(t,"Cache-Control");w&&t.setResponseHeader("Cache-Control",null,!1);var g=GetRespHeader(t,"Expires");g&&t.setResponseHeader("Expires",null,!1)}for(var k in h){d.headers=h;break}var b=NAME_PATTERN.exec(t.name);b&&(d.urlFilename=b[1]),d.title=d.headerFilename||d.urlFilename||_("media"),l?(d.type="video",d.extension=l[1]):u?(d.type=u[1],d.extension=u[2]):d.extension=p;var x=GetReqHeader(t,"referer");x&&(d.referrer=x);var i=null,a=GetRespHeader(t,"Content-Range");if(a){var o=RANGE_PATTERN.exec(a);o&&(i=o[1])}i||(i=s),i=parseInt(i),isNaN(i)||(d.length=i);var T=null;if(t.loadGroup&&t.loadGroup.notificationCallbacks)try{var P=t.loadGroup.notificationCallbacks.QueryInterface(Ci.nsIInterfaceRequestor);T=P.getInterface(Ci.nsIDOMWindow)}catch(C){}if(null==T&&t.notificationCallbacks)try{var N=t.notificationCallbacks.getInterface(Ci.nsILoadContext);N.topFrameElement&&(T=N.topFrameElement._contentWindow||null)}catch(C){}if(null==T&&t.notificationCallbacks)try{var H=t.notificationCallbacks.QueryInterface(Ci.nsIInterfaceRequestor);T=H.getInterface(Ci.nsIDOMWindow)}catch(C){}T&&timers.setTimeout(function(){var e=!1;try{e=/^(audio|video)/.test(T.document.contentType)}catch(t){}var n=T.top?T.top.document.URL:T.document.URL,s=d.extension?d.extension.toLowerCase():"",i=smartNames.specForUrl(n);if(!i.contentNeeded||e){d.pageUrl=T.document.URL,d.topUrl=T.top.document.URL,"obfuscated"==i.spec.mode&&(d.title=smartNames.getObfuscated(n)),d.isPrivate=privateBrowsing.isPrivate(T);for(var a in tabs){var o=tabs[a];if(o.url==n){{viewFor(o)}try{e10sEnabled||(d.thumbnail=o.getThumbnail())}catch(t){}}}r?tbvws.handleNetworkHook(r,d):f?f.handleHit(d):NotifyHit(d)}else i.spec.delay?timers.setTimeout(function(){WorkerForContent(T,d,r,f,i,n,s)},i.spec.delay):WorkerForContent(T,d,r,f,i,n,s)},0)}}}function NotifyHit(e){listeners.forEach(function(t){t(e)})}function DoNothing(){}function StartStop(e){var t=simplePrefs.prefs["network-probe"];t&&!e||!running?t&&!running&&(running=!0,UpdateFilterOut(),events.on("http-on-examine-response",ListenResponse),events.on("http-on-examine-cached-response",ListenResponse)):(running=!1,events.off("http-on-examine-response",ListenResponse),events.off("http-on-examine-cached-response",ListenResponse))}const events=require("sdk/system/events"),$chrome=require("chrome"),Cc=$chrome.Cc,Ci=$chrome.Ci,Cu=$chrome.Cu,windowUtils=require("sdk/window/utils"),once=require("sdk/event/core").once,self=require("sdk/self"),_=require("sdk/l10n").get,tabs=require("sdk/tabs"),privateBrowsing=require("sdk/private-browsing"),Worker=require("sdk/content/worker").Worker,tbvws=require("./tbvws"),chunks=require("./chunks"),timers=require("sdk/timers"),viewFor=require("sdk/view/core").viewFor,simplePrefs=require("sdk/simple-prefs"),utils=require("./utils"),smartNames=require("./smartnames"),TYPE_PATTERN=new RegExp("^(audio|video)/(?:x-)?([^; ]+)"),RANGE_PATTERN=new RegExp("^bytes [0-9]+-[0-9]+/([0-9]+)$"),EXT_PATTERN=new RegExp("\\.([a-z0-9]{1,5})(?:\\?|#|$)","i"),NAME_PATTERN=new RegExp("/([^/]+?)(?:\\.([a-z0-9]{1,5}))?(?:\\?|#|$)","i"),CDFNAME_PATTERN=new RegExp('filename\\s*=\\s*"\\s*([^"]+?)\\s*"'),TBVWS_DASH_SEG_PATTERN=new RegExp("mpd_version");Cu["import"]("resource://gre/modules/Services.jsm");var e10sEnabled=Services.appinfo.browserTabsRemoteAutostart,running=!1,listeners=[],extensions={};UpdateExtensions(),simplePrefs.on("media-extensions",UpdateExtensions);var filterOutRE=null;simplePrefs.on("network-filter-out",UpdateFilterOut),simplePrefs.on("network-probe",function(){StartStop()}),StartStop(),exports.addListener=function(e){listeners.push(e)},exports.removeListener=function(e){var t=listeners.indexOf(e);t>=0&&listeners.splice(t,1)},require("sdk/system/unload").when(function(){StartStop(!0)});