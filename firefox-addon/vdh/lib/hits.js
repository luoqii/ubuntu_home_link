/* Copyright (C) 2006-2016 Michel Gutierrez <mig@downloadhelper.net>
 * All Rights Reserved
 * 
 * If you are interested in methods used in this project, follow the
 * open source project at https://github.com/mi-g/fang
 */

function DoUpdateCurrentUrl(){updateTimer=null;var t,i=windows.activeWindow;if(i){var e=i.tabs.activeTab;if(!e)return;t=e.url}else{var r=windowMediator.getMostRecentWindow("navigator:browser");if(!r||!r.content)return;t=r.content.location.href}if(t!=activeUrl){activeUrl=t;var s={};for(var a in tabs)s[tabs[a].url]=1;for(var n in hits){var o=hits[n];"active"==o.status&&o.data.topUrl!=t?o.setStatus(o.data.topUrl in s?"inactive":"orphan"):"inactive"!=o.status||o.data.topUrl in s?"inactive"!=o.status&&"orphan"!=o.status||o.data.topUrl!=t||o.setStatus("active"):o.setStatus("orphan")}}}function UpdateCurrentUrl(){updateTimer&&timers.clearTimeout(updateTimer),updateTimer=timers.setTimeout(DoUpdateCurrentUrl,50)}function GetHitData(t){return merge({status:t.status,timestamp:t.timestamp,progress:t.progress,operation:t.operation,orphanStart:t.orphanStart,orphanEnd:t.orphanEnd},t.data)}function DoNotifyHits(){notifyTimer=null;var t={};for(var i in hits){var e=hits[i],r=GetHitData(e);t[i]=r;for(var s in modifiers)modifiers[s](r)}listeners.forEach(function(i){i(t)})}function NotifyHits(){notifyTimer&&timers.clearTimeout(notifyTimer),notifyTimer=timers.setTimeout(DoNotifyHits,NOTIFY_TIMEOUT)}const $chrome=require("chrome"),Cc=$chrome.Cc,Ci=$chrome.Ci,Cu=$chrome.Cu,Class=require("sdk/core/heritage").Class,merge=require("sdk/util/object").merge,timers=require("sdk/timers"),tabs=require("sdk/tabs"),simplePrefs=require("sdk/simple-prefs"),$core=require("sdk/view/core"),windows=require("sdk/windows").browserWindows,prefs=require("./prefs"),utils=require("./utils"),actions=require("./actions"),blacklist=require("./blacklist"),NOTIFY_TIMEOUT=100,UNREADY_STATES={running:1},READY_STATES={initial:1,active:1,inactive:1,orphan:1,pinned:1};var listeners=[],hits={},notifyTimer=null,updateTimer=null,activeUrl=null,windowMediator=Cc["@mozilla.org/appshell/window-mediator;1"].getService(Ci.nsIWindowMediator);tabs.on("activate",function(){UpdateCurrentUrl()}),tabs.on("ready",function(){UpdateCurrentUrl()}),tabs.on("close",function(){UpdateCurrentUrl()}),windows.on("activate",function(){UpdateCurrentUrl()}),windows.on("deactivate",function(){UpdateCurrentUrl()}),exports.updateCurrentUrl=UpdateCurrentUrl;var Hit=Class({initialize:function(){this.data={},this.dataSign="mZFLkyvTelC5g8XnyQrpOw==",this.timestamp=Date.now(),this.status="initial",this.progress=-1,this.operation=null,this.expireTimer=null,this.pinned=!1,this.setReadyStatus(),this.currentAction=null},update:function(t){if(this.data=merge(this.data,t),blacklist.checkHitBlacklisted(this.data))return void this.remove();this.updateActions(),this.status in READY_STATES&&this.setReadyStatus();var i=this.dataSign;return this.dataSign=utils.md5(this.data),i!=this.dataSign},stopExpireTimer:function(){this.expireTimer&&(timers.clearTimeout(this.expireTimer),this.expireTimer=null)},restartExpireTimer:function(){var t=this;this.stopExpireTimer();var i=Date.now();this.orphanStart=i,this.orphanEnd=i+1e3*simplePrefs.prefs["orphan-expiration"],this.expireTimer=timers.setTimeout(function(){t.expireTimer=null,hits[t.data.id]&&t.remove()},1e3*simplePrefs.prefs["orphan-expiration"])},action:function(t){this.progress=0,this.operation=null,actions.perform(t,this),this.update()},setStatus:function(t){t!=this.status&&(this.status=t,"orphan"==t?this.restartExpireTimer():this.stopExpireTimer(),this.updateActions(),NotifyHits())},setReadyStatus:function(){var t="orphan";if(this.pinned)t="pinned";else if(tabs.activeTab&&this.data.topUrl==tabs.activeTab.url)t="active";else{var i={};for(var e in tabs)i[tabs[e].url]=1;this.data.topUrl in i&&(t="inactive")}this.setStatus(t)},setProgress:function(t){if(t!=this.progress){this.progress=t;var i=this;listeners.forEach(function(e){e(t,[i.data.id,"progress"])})}},setOperation:function(t){if(t!=this.operation){this.operation=t;var i=this;listeners.forEach(function(e){e(t,[i.data.id,"operation"])})}},updateActions:function(){this.data.actions=actions.availableActions(this),NotifyHits()},remove:function(){delete hits[this.data.id],NotifyHits()},pin:function(){this.pinned=!0,"running"!=this.status&&this.setReadyStatus()},setCurrentAction:function(t){null==t&&(this.operation=null),this.currentAction=t}}),modifiers={};exports.newData=function(t){Array.isArray(t)||(t=[t]);var i=!1;if(t.forEach(function(t){var e=hits[t.id];if(!e){if(t.topUrl&&t.pageUrl&&t.topUrl!=t.pageUrl&&simplePrefs.prefs["ignore-embedded"])return;e=new Hit,hits[t.id]=e,t.autoExec&&timers.setTimeout(function(){e.action(t.autoExec)},0)}i=e.update(t)||i}),simplePrefs.prefs["max-hits-per-source"]>0){var e={};for(var r in hits){var s=hits[r],a=s.data.pageUrl||s.data.topUrl;if(a){var n=e[a];n||(n=[],e[a]=n),n.push(s)}}for(var o in e){var u=e[o];if(u.length>simplePrefs.prefs["max-hits-per-source"]){u.sort(function(t,i){return i.timestamp-t.timestamp});for(var p=simplePrefs.prefs["max-hits-per-source"];p<u.length;p++){var s=u[p];s.remove()}}}}i&&NotifyHits()},exports.action=function(t,i){var e=hits[i];e&&e.action(t)},exports.remove=function(t){var i=hits[t];i&&i.remove()},exports.getHit=function(t){return hits[t]||null},exports.addListener=function(t){listeners.push(t)},exports.removeListener=function(t){var i=listeners.indexOf(t);i>=0&&listeners.splice(i,1)},exports.clear=function(t){for(var i in hits){var e=hits[i];("all"==t&&"running"!=e.status&&"pinned"!=e.status||"pinned"==t&&"pinned"==e.status||"inactive"==t&&"inactive"==e.status||"orphans"==t&&"orphan"==e.status)&&e.remove()}},exports.refresh=function(){for(var t in hits)hits[t].update()},exports.getHitData=function(t){var i=hits[t];return i?(i.update(),GetHitData(i)):null},exports.defaultAction=function(){var t=null,i=[];for(var e in hits){var t=hits[e];"active"==t.status&&t.data.actions.indexOf("quickdownload")>=0&&i.push(t)}i.sort(function(t,i){return t.timestamp==i.timestamp?(t.order||0)-(i.order||0):t.timestamp-i.timestamp}),i.length>0&&exports.action("quickdownload",i[0].data.id)},exports.executeDefaultAction=function(t){var i=hits[t];i&&i.data.actions.length>0&&i.action(i.data.actions[0])},exports.registerModifier=function(t,i){modifiers[t]=i},exports.unregisterModifier=function(t){delete modifiers[t]},exports.getFileNamesInUse=function(){var t={};for(var i in hits){var e=hits[i].data;t[e._downloadTarget]=1,t[e._finalTarget]=1,t[e._audioTarget]=1,t[e._videoTarget]=1}return delete t[void 0],t};