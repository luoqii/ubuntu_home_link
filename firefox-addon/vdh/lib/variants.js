/* Copyright (C) 2006-2016 Michel Gutierrez <mig@downloadhelper.net>
 * All Rights Reserved
 * 
 * If you are interested in methods used in this project, follow the
 * open source project at https://github.com/mi-g/fang
 */

function FixAddMixedVariants(){for(var e in simpleStorage.storage.variants.adp_audio)for(var i in simpleStorage.storage.variants.adp_video)simpleStorage.storage.variants.adp_list.indexOf(i+"/"+e)<0&&simpleStorage.storage.variants.adp_list.push(i+"/"+e)}function EnsuresData(){simpleStorage.storage.variants||exports.resetVariants(),done_FixAddMixedVariants||(FixAddMixedVariants(),done_FixAddMixedVariants=!0)}const $chrome=require("chrome"),Cc=$chrome.Cc,Ci=$chrome.Ci,Cu=$chrome.Cu,simpleStorage=require("sdk/simple-storage"),simplePrefs=require("sdk/simple-prefs"),merge=require("sdk/util/object").merge,_=require("sdk/l10n").get,TYPE_RE=new RegExp('^(audio|video)/(?:x\\-)?([^;]+)(?:;\\+codecs="(.+)")?$'),ADPID_RE=new RegExp("^([0-9]*)/([0-9]*)$"),SLASHID_RE=new RegExp("^(.*)/(.*)$"),ADPLISTID_RE=new RegExp("^adp:[0-9]+$");exports.resetVariants=function(){simpleStorage.storage.variants={full:{"tbvws:22":{extension:"mp4",quality:"hd720",audioCodec:"+mp4a.40.2",videoCodec:"avc1.64001F",enabled:!0,label:"MP4 - 1280x720",size:"1280x720"},"tbvws:18":{extension:"mp4",quality:"medium",audioCodec:"+mp4a.40.2",videoCodec:"avc1.42001E",enabled:!0,label:"MP4 - 480x360",size:"480x360"},"tbvws:43":{extension:"webm",quality:"medium",audioCodec:"+vorbis",videoCodec:"vp8.0",enabled:!0,label:"WEBM - 480x360",size:"480x360"},"tbvws:5":{extension:"flv",quality:"small",audioCodec:null,videoCodec:null,enabled:!0,label:"FLV - 320x240",size:"320x240"},"tbvws:36":{extension:"3gpp",quality:"small",audioCodec:"+mp4a.40.2",videoCodec:"mp4v.20.3",enabled:!0,label:"3GPP - 320x240",size:"320x240"},"tbvws:17":{extension:"3gpp",quality:"small",audioCodec:"+mp4a.40.2",videoCodec:"mp4v.20.3",enabled:!0,label:"3GPP - 176x144",size:"176x144"},"tfvws:1080-0":{extension:"mp4",audioCodec:null,videoCodec:null,enabled:!0,size:"1920x1080",label:"H264_1920x1080 -MP4"},"tfvws:720-0":{extension:"mp4",audioCodec:null,videoCodec:null,enabled:!0,size:"1280x720",label:"H264_1280x720 -MP4"},"tfvws:480-0":{extension:"mp4",audioCodec:null,videoCodec:null,enabled:!0,size:"848x480",label:"H264_848x480 -MP4"},"tfvws:380-0":{extension:"mp4",audioCodec:null,videoCodec:null,enabled:!0,size:"512x384",label:"H264_512x384 -MP4"},"tfvws:240-0":{extension:"mp4",audioCodec:null,videoCodec:null,enabled:!0,size:"320x240",label:"H264_320x240 -MP4"}},full_list:["tbvws:22","tbvws:18","adp:1","tbvws:5","tbvws:17","adp:2","tbvws:43","tbvws:36","tfvws:1080-0","tfvws:720-0","tfvws:480-0","tfvws:380-0","tfvws:240-0","adp:3","adp:4"],adp_audio:{140:{extension:"mp4",bitRate:"127856",codec:"mp4a.40.2"},171:{extension:"webm",bitRate:"133658",fps:"1",codec:"vorbis"}},adp_video:{133:{extension:"mp4",size:"320x240",bitRate:"248086",fps:"30",codec:"avc1.4d400d"},134:{extension:"mp4",size:"640x360",bitRate:"338730",fps:"30",codec:"avc1.4d401e"},135:{extension:"mp4",size:"854x480",bitRate:"721213",fps:"30",codec:"avc1.4d401f"},136:{extension:"mp4",size:"1280x720",bitRate:"1124376",fps:"30",codec:"avc1.4d401f"},137:{extension:"mp4",size:"1920x1080",bitRate:"4137966",fps:"30",codec:"avc1.640028"},160:{extension:"mp4",size:"192x144",bitRate:"111449",fps:"15",codec:"avc1.4d400c"},242:{extension:"webm",size:"320x240",bitRate:"180842",fps:"1",codec:"vp9"},243:{extension:"webm",size:"320x240",bitRate:"332350",fps:"1",codec:"vp9"},244:{extension:"webm",size:"854x480",bitRate:"419080",fps:"30",codec:"vp9"},247:{extension:"webm",size:"1280x720",bitRate:"877134",fps:"30",codec:"vp9"},248:{extension:"webm",size:"1920x1080",bitRate:"2835123",fps:"30",codec:"vp9"},264:{extension:"mp4",size:"2560x1440",bitRate:"9957081",fps:"25",codec:"avc1.640032"},266:{extension:"mp4",size:"3840x2160",bitRate:"22215059",fps:"25",codec:"avc1.640033"},271:{extension:"webm",size:"2560x1440",bitRate:"9227182",fps:"25",codec:"vp9"},278:{extension:"webm",size:"256x144",bitRate:"96779",fps:"1",codec:"vp9"},298:{extension:"mp4",size:"1280x720",bitRate:"3317977",fps:"60",codec:"avc1.4d4020"},299:{extension:"mp4",size:"1920x1080",bitRate:"5546416",fps:"60",codec:"avc1.64002a"},302:{extension:"webm",size:"1280x720",bitRate:"3752347",fps:"60",codec:"vp9"},303:{extension:"webm",size:"1920x1080",bitRate:"6088401",fps:"60",codec:"vp9"},313:{extension:"webm",size:"3840x2160",bitRate:"22856955",fps:"25",codec:"vp9"}},adp_list:["266/140","264/140","137/140","136/140","266/171","264/171","137/171","136/171","248/140","248/171","299/140","299/171","303/140","303/171","247/140","247/171","298/140","298/171","302/140","302/171","135/140","135/171","244/140","244/171","134/140","134/171","133/140","243/171","242/140","243/140","242/171","133/171","278/140","278/171","160/140","160/171","264/","133/","242/","243/","160/","/140","/171","136/","247/","135/","244/","134/","137/","248/","278/","299/","303/","298/","302/","266/","313/140","313/171","313/","271/140","271/171","271/"]}};var done_FixAddMixedVariants=!1;exports.getHitsFromVariants=function(e,i,a){a=a||{},EnsuresData();var s={},t={},o=simplePrefs.prefs["ignore-protected"];i.forEach(function(i){if(i.url&&!(o&&!a.keepProtected&&i.s&&i.s.length>0)){s[i.itag]=i;var r=e.from+":"+i.itag,n="audio/video",d=null,p=null,l=null,v=simpleStorage.storage.variants.full[r];if(v){if(!v.enabled)return;v.audioCodec&&(d=v.audioCodec,n="audio"),v.videoCodec&&(p=v.videoCodec,n=d?"audio/video":"video"),l=v.extension}else if(void 0!==i.type){var u=TYPE_RE.exec(i.type);if(u)if(l=u[2],"audio"==u[1])n="audio",d=u[3]||null,/vorbis|opus/i.test(d)&&(l="webm");else if(u[3]){var c=u[3].split(",");1==c.length?(n="video",p=c[0],/vp8|vp9/i.test(p)&&(l="webm")):(p=c[0],d=c[1])}else"video"==u[1]&&(n="video")}if(l=l||"mp4","audio/video"===n){var g={id:e.from+":"+e.videoId+":"+i.itag,url:i.url,extension:l};i.quality&&(g.quality=i.quality),d&&(g.audioCodec=d),p&&(g.videoCodec=p),i.size&&(g.size=i.size),i.fps&&(g.fps=i.fps),i.s&&(g._signature=i.s),t[r]=g;var v=simpleStorage.storage.variants.full[r];if(void 0===v){simpleStorage.storage.variants.full[r]={extension:l,quality:i.quality,audioCodec:d,videoCodec:p,enabled:!0};var f=[];if(f.push("("+r+")"),i.quality){var x="quality-"+i.quality,m=_(x);m==x&&(m=i.quality.toUpperCase()),f.push(m)}i.size&&f.push(i.size),f.push(l.toUpperCase()),p&&f.push("V/"+p),d&&f.push("A/"+d),simpleStorage.storage.variants.full[r].label=f.join(" - "),simpleStorage.storage.variants.full_list.push(r)}else!i.size&&v.size&&(g.size=v.size)}else{var b,S;if("audio"==n?(b="adp_audio",S="adp_video"):(b="adp_video",S="adp_audio"),void 0===simpleStorage.storage.variants[b][i.itag]){var z={extension:l};i.size&&(z.size=i.size),i.bitrate&&(z.bitRate=i.bitrate),i.fps&&(z.fps=i.fps),simpleStorage.storage.variants[b][i.itag]=z;for(var h in simpleStorage.storage.variants[S])simpleStorage.storage.variants.adp_list.push("audio"==n?h+"/"+i.itag:i.itag+"/"+h);"audio"==n?(simpleStorage.storage.variants[b][i.itag].codec=d,simpleStorage.storage.variants.adp_list.push("/"+i.itag)):(simpleStorage.storage.variants[b][i.itag].codec=p,simpleStorage.storage.variants.adp_list.push(i.itag+"/"))}}}});for(var r=e.maxVariants||simplePrefs.prefs["qualities-max"],n=0,d=[],p=null,l=0;l<simpleStorage.storage.variants.full_list.length&&(!r||r>n);l++){var v=simpleStorage.storage.variants.full_list[l],u=/^adp:([0-9]+)$/.exec(v);if(u){if(simplePrefs.prefs["adp.hide"])continue;p||(p=[],simpleStorage.storage.variants.adp_list.forEach(function(i){if(!a.audioAndVideo||/^\d+\/\d+$/.test(i)){var t=ADPID_RE.exec(i);if(!(t[1].length>0&&!s[t[1]]||t[1].length>0&&simpleStorage.storage.variants.adp_video[t[1]]&&"vp9"==simpleStorage.storage.variants.adp_video[t[1]].codec&&simpleStorage.storage.converter&&!simpleStorage.storage.converter.vp9support||t[2].length>0&&!s[t[2]])){var o=s[t[1]],r=s[t[2]],n={id:e.from+":"+e.videoId+":"+i,_signature:[]},d=0,l=null,v=null;o&&(n.videoUrl=o.url,o.clen&&(d+=parseInt(o.clen)),r||(n.url=n.videoUrl),o.s&&n._signature.push(o.s),l=simpleStorage.storage.variants.adp_video[t[1]],n.extension=o.extension||(l?l.extension:void 0),o.size&&(n.size=o.size),!n.size&&l&&l.size&&(n.size=l.size),o.fps&&(n.fps=o.fps),!n.fps&&l&&l.fps&&(n.fps=l.fps)),r&&(v=simpleStorage.storage.variants.adp_audio[t[2]],n.audioUrl=r.url,r.clen&&(d+=parseInt(r.clen)),o||(n.url=n.audioUrl,n.extension=r.extension),r.s&&n._signature.push(r.s)),v&&l&&v.extension!=l.extension&&(n.extension="mkv"),d&&(n.length=d),p.push(n)}}}));var c=parseInt(u[1])-1;c<p.length&&(d[n++]=merge({order:n,adp:!0},e,p[c]))}else t[v]&&(d[n++]=merge({order:n},e,t[v]))}return d},exports.getVariantsList=function(){EnsuresData();var e=[],i=simplePrefs.prefs["adaptative-count"],a=1;for(simpleStorage.storage.variants.full_list.forEach(function(s){if(ADPLISTID_RE.test(s)){if(a>i)return;e.push({id:"adp:"+a,label:_("adaptative",a)}),a++}else{var t=simpleStorage.storage.variants.full[s];t&&e.push({id:s,label:t.label,enabled:t.enabled})}});i>=a;a++)e.push({id:"adp:"+a,label:_("adaptative",a)});return e},exports.setVariantsList=function(e){simpleStorage.storage.variants.full_list=[],e.forEach(function(e){simpleStorage.storage.variants.full_list.push(e.id),ADPLISTID_RE.test(e.id)||(simpleStorage.storage.variants.full[e.id].enabled=e.enabled)})},exports.getAdpVariantsList=function(){EnsuresData();var e=[];return simpleStorage.storage.variants.adp_list.forEach(function(i){var a=SLASHID_RE.exec(i);if(i){var s=simpleStorage.storage.variants.adp_video[a[1]],t=simpleStorage.storage.variants.adp_audio[a[2]];if(s||t){var o=[];s&&!t?(o.push(_("video-only")),o.push(s.extension.toUpperCase())):!s&&t?(o.push(_("audio-only")),o.push(t.extension.toUpperCase())):o.push(s.extension.toUpperCase()),s&&(s.size&&o.push(s.size),s.fps&&o.push(s.fps+" fps"),s.codec&&o.push(s.codec)),t&&t.codec&&o.push(t.codec),e.push({id:i,label:o.join(" - ")})}}}),e},exports.setAdpVariantsList=function(e){simpleStorage.storage.variants.adp_list=[],e.forEach(function(e){simpleStorage.storage.variants.adp_list.push(e.id)})},exports.orderAdaptative=function(){simpleStorage.storage.variants.adp_list.sort(function(e,i){var a=SLASHID_RE.exec(e),s=SLASHID_RE.exec(i),t=simpleStorage.storage.variants.adp_video[a[1]],o=simpleStorage.storage.variants.adp_video[s[1]],r=simpleStorage.storage.variants.adp_audio[a[2]],n=simpleStorage.storage.variants.adp_audio[s[2]],d=t&&parseInt(t.size)||0,p=o&&parseInt(o.size)||0,l=r?1:0,v=n?1:0;return p*v-d*l})},exports.hasAudioVideo=function(e){var i={audio:!1,video:!1},a=simpleStorage.storage.variants.full[e];return a&&(i.audio=!!a.audioCodec,i.video=!!a.videoCodec),i};