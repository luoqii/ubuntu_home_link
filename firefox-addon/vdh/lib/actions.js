/* Copyright (C) 2006-2016 Michel Gutierrez <mig@downloadhelper.net>
 * All Rights Reserved
 * 
 * If you are interested in methods used in this project, follow the
 * open source project at https://github.com/mi-g/fang
 */

const $chrome=require("chrome"),Cc=$chrome.Cc,Ci=$chrome.Ci,Cu=$chrome.Cu,Class=require("sdk/core/heritage").Class,merge=require("sdk/util/object").merge,_=require("sdk/l10n").get,self=require("sdk/self"),$viewCore=require("sdk/view/core"),viewFor=$viewCore.viewFor,path=require("sdk/fs/path"),simplePrefs=require("sdk/simple-prefs"),downloads=require("./downloads"),alerts=require("./alerts"),panels=require("./panels"),blacklist=require("./blacklist"),hits=require("./hits"),log=require("./log"),converter=require("./converter"),masked=require("./masked"),utils=require("./utils"),FNAME_RE=new RegExp('[/?<>\\:*|":]|[\x00--]|\\\\',"g"),SPACE_RE=new RegExp(" +","g"),DOTS_RE=new RegExp("\\.","g"),LEAFNAME_RE=new RegExp("^(.*)-([0-9]+)(\\.?[^\\.]*)$|^(.*?)(\\.[^\\.]*)?$");var transientStorageDirectory=null,Action=Class({initialize:function(t){this.hit=t},start:function(){log.error(_("not-implemented-yet"))},abort:function(){log.error(_("action-cannot-abort"))},createUnique:function(t,e,i){var a=hits.getFileNamesInUse();if(t.createUnique(e,i),t.path in a){for(t.remove(!0);;){var r=LEAFNAME_RE.exec(t.leafName);if(t.leafName=void 0!==r[1]?r[1]+"-"+(parseInt(r[2])+1)+r[3]:r[4]+"-1"+(r[5]||""),!(t.path in a||t.exists()))break}t.create(e,i)}},getDefaultTargetFile:function(t){var e=this.getDownloadDirectory();e.append(t);try{this.createUnique(e,Ci.nsIFile.NORMAL_FILE_TYPE,420)}catch(i){throw _("error.cannot-create-target-file",e.path)}return e.remove(!0),e},getTargetFilePath:function(t,e){Cu["import"]("resource://gre/modules/FileUtils.jsm");var i=this.getDefaultTargetFile(t),a=null,r=/\.([^\.]{1,5})$/.exec(i.leafName);r&&(a=r[1]);var o=Cc["@mozilla.org/appshell/window-mediator;1"].getService(Ci.nsIWindowMediator),n=o.getMostRecentWindow("navigator:browser"),s=require("sdk/windows").browserWindows.activeWindow,c=Cc["@mozilla.org/filepicker;1"].createInstance(Ci.nsIFilePicker);c.init(n,_("title.save-file"),Ci.nsIFilePicker.modeSave),c.displayDirectory=i.parent,c.defaultString=i.leafName,c.appendFilters(Ci.nsIFilePicker.filterAll);{var l=this,d=!1;c.open(function(o){if(s.activate(),o==Ci.nsIFilePicker.returnCancel&&e(null),i=c.file,a){var n=i.leafName,h=n;r=/^(.*)\.([^\.]{1,5})$/.exec(n),r?r[2]!=a&&(d=r[2]):(i=i.parent,i.append(h+"."+a))}transientStorageDirectory=i.parent.path,l.hit.data.isPrivate||(simplePrefs.prefs.storagedirectory=i.parent.path),d&&!simplePrefs.prefs["file-ext-change-not-again"]?alerts.alert({title:_("file-ext-change"),text:_("file-ext-change-text",a,d),button:[{text:_("back"),click:"post('back')"},{text:_("continue"),click:"post('continue')",buttonClass:"btn-success"}],notAgain:"file-ext-change-not-again",onMessage:function(a,r){switch(a.type){case"back":r.hide(),l.getTargetFilePath(t,e);break;case"continue":r.hide(),l.hit.data.extension=d,e(i.path)}}}):e(i.path)})}},changeDownloadDirectory:function(t){exports.changeStorageDirectory(this.hit.data.isPrivate,t)},getDownloadDirectory:function(){return exports.getDownloadDirectory(this.hit.data.isPrivate)},getTmpFile:function(t,e){var i="tmp";if(t)i=t;else if(e){var a=/\.([0-9a-zA-Z]{1,5})(?:\?|$)/.exec(e);a&&(i=a[1])}Cu["import"]("resource://gre/modules/FileUtils.jsm");var r=FileUtils.getFile("TmpD",["media."+i]);return this.createUnique(r,Ci.nsIFile.NORMAL_FILE_TYPE,FileUtils.PERMS_FILE),r.path},notifyRunning:function(t){t?this.hit.setStatus("running"):this.hit.setReadyStatus()},getFilename:function(t){t=t||{};var e=this.hit.data.title||"video",i="";t.noExtension||(i=this.hit.data.extension||"mp4"),e=e.replace(FNAME_RE,""),t.noExtension||(i=i.replace(FNAME_RE,""));var a={keep:" ",remove:"",hyphen:"-",underscore:"_"};e=e.replace(SPACE_RE,a[simplePrefs.prefs["smartnamer.fname.spaces"]]),i=i.replace(SPACE_RE,a[simplePrefs.prefs["smartnamer.fname.spaces"]]),t.dotsByUnderscores&&(e=e.replace(DOTS_RE,"_"));var r=simplePrefs.prefs["smartnamer.fname.maxlen"];return e.length+i.length+1>r&&(e=e.substr(0,r-i.length-1)),i?e+"."+i:e},download:function(t,e,i,a){this.hit.data.f4f?require("./f4f").download(this,t,e,i,a):this.hit.data.chunked?require("./chunks").download(this,t,e,i,a):this.regularDownload(t,e,i,a)},regularDownload:function(t,e,i,a){function r(){var a=!0,r=!0;t.forEach(function(t){a=a&&t.done,r=r&&t.success}),a&&(n.downloadSpecs=null,r?e():i())}this.downloadSpecs=t;var o=-1,n=this;t.forEach(function(e){e.progress=0,e.done=!1;var i={source:{url:e.url,isPrivate:e.isPrivate},target:{path:e.target}};simplePrefs.prefs["download.retries"]&&(i.target.partFilePath=i.target.path+".part",i.saver="copy"),e.referrer&&(i.source.referrer=e.referrer),e.id=n.initiateDownload(i,function(){e.success=!0,e.done=!0,r()},function(t){2147500037==t.result?log.log(t.message):log.error(t.message?t.message:t),e.success=!1,e.done=!0,r()},function(i){var r=0;e.progress=i,t.forEach(function(t){r+=t.progress}),r=Math.round(r/t.length),r!=o&&(o=r,a(r))},e.headers)})},initiateDownload:function(t,e,i,a,r){return downloads.download(t,e,i,a,r)},abortDownload:function(){if(this.hit.abortFn)this.hit.abortFn(this);else{if(!this.downloadSpecs)return void log.error(_("no-download-to-abort"));this.downloadSpecs.forEach(function(t){t.done||downloads.abort(t.id)})}},checkConverter:function(t,e,i){function a(){if("ready"==converter.config().status)t(!0);else{var a=[{text:_("install-converter"),click:"post('installConverter')"}];i&&a.unshift({text:i.text,click:"post('moreInfo')"}),alerts.alert({title:_("converter-required"),text:e,action:a,onMessage:function(t,e){switch(t.type){case"installConverter":e.hide(),require("sdk/tabs").open({url:"http://www.downloadhelper.net/install-converter3.php"});break;case"moreInfo":e.hide(),require("sdk/tabs").open({url:i.url})}}}),t(!1)}}e=e||_("converter-needed"),"ready"==converter.config().status&&converter.isPresent()?a():converter.check(a)},notifyProcessed:function(){if(simplePrefs.prefs["notify-ready"]&&(!this.hit.data.isPrivate||!simplePrefs.prefs["no-private-notification"])){var t=require("sdk/notifications");t.notify({title:_("vdh-notification"),text:_("file-ready",this.hit.data.title),iconURL:self.data.url("images/icon-36.png"),data:this.hit.data.id,onClick:function(t){hits.executeDefaultAction(t)}})}},explainQR:function(){if(!simplePrefs.prefs["qr-message-not-again"]){var t=this;panels.togglePanel("qr",{contentURL:"qrPanel.html",top:10,closeTimeout:0,jsFiles:["qrPanel.js"],onShow:function(e){converter.config();e.port.emit("contentMessage",{type:"set",name:"hit",value:t.hit.data})},onMessage:function(t,e){switch(t.type){case"goto":switch(e.hide(),t.where){case"get-license":require("sdk/tabs").open({url:"http://www.downloadhelper.net/convert.php"});break;case"tell-more":require("sdk/tabs").open({url:"http://www.downloadhelper.net/about-licensing.php"})}}}})}}}),DownloadAction=merge(Class({"extends":Action,start:function(){function t(){if(this.hit.data._convert||converter.updateHit(this.hit),this.hit.data._convert&&this.hit.data._convert.audioonly){var t=converter.config().license.status;if("unneeded"!=t&&"accepted"!=t)return void alerts.alert({title:_("converter-needs-reg"),text:_("converter-reg-audio"),action:{text:_("register-converter"),click:"post('registerConverter')"},onMessage:function(t,e){switch(t.type){case"registerConverter":e.hide(),require("sdk/tabs").open({url:"http://www.downloadhelper.net/convert.php"})}}})}var e=this;this.getDownloadTargetFilePath(this.getFilename(),function(t){t&&(e.hit.data._finalTarget=t,e.notifyRunning(!0),e.hit.setCurrentAction(e),e.downloadMedia())})}function e(){i.masked?masked.prepareMaskedAction(i,function(e){e?console.error(e):(masked.info(),t.call(i))}):t.call(i)}var i=this;!this.hit.data.url&&this.hit.data.audioUrl&&this.hit.data.videoUrl?this.checkConverter(function(t){t&&e.call(i)},_("converter-needed-aggregate"),{text:_("converter-needed-aggregate-why"),url:"http://www.downloadhelper.net/why-converter-needed-aggregation.php"}):this.hit.data.url||this.hit.data.audioUrl||this.hit.data.videoUrl?e.call(this):this.hit.data.urls&&this.downloadGallery()},downloadGallery:function(){function t(){simplePrefs.prefs["auto-pin"]&&a.hit.pin(),a.hit.data.localContainerPath=a.hit.data._finalTarget,a.hit.updateActions(),a.notifyProcessed(),e()}function e(){a.cleanup(),a.hit.setCurrentAction(null),a.notifyRunning(!1)}function i(t){a.hit.setOperation("downloading..."),a.hit.setProgress(t)}var a=this;try{this.getDownloadTargetDirPath(this.getFilename({noExtension:!0,dotsByUnderscores:!0}),function(r){if(r){Cu["import"]("resource://gre/modules/FileUtils.jsm");var o=new FileUtils.File(r);try{a.createUnique(o,Ci.nsIFile.DIRECTORY_TYPE,493)}catch(n){return void log.error(_("error.cannot-create-target-directory",o.path))}a.hit.data._finalTarget=o.path,transientStorageDirectory=o.parent.path,a.hit.data.isPrivate||(simplePrefs.prefs.storagedirectory=o.parent.path),a.notifyRunning(!0),a.hit.setCurrentAction(a),a.hit.updateActions();var s=[],c=1;a.hit.data.urls.forEach(function(t){var e=o.clone(),i=/([^\/]+)$/.exec(t);if(i){var r=decodeURIComponent(i[1]);simplePrefs.prefs["medialink-index-prefix"]&&(r="0000".substring(0,4-(""+c).length)+c+"-"+r),c++,e.append(r),s.push({url:t,target:e.path,isPrivate:a.hit.data.isPrivate})}}),s.forEach(function(t){a.hit.data.pageUrl&&(t.referrer=a.hit.data.pageUrl),a.hit.data.headers&&(t.headers=a.hit.data.headers)}),a.hit.setOperation("queued..."),a.download(s,t,e,i)}})}catch(r){log.error(r)}},getDownloadTargetDirPath:function(t,e){var i=require("sdk/windows"),a=i.browserWindows.activeWindow,r=viewFor(a),o=Cc["@mozilla.org/filepicker;1"].createInstance(Ci.nsIFilePicker);o.init(r,_("prompt.target-dir"),Ci.nsIFilePicker.modeSave);var n=null;try{n=this.getDownloadDirectory(),n.append(t),this.createUnique(n,Ci.nsIFile.DIRECTORY_TYPE,493),n.remove(!0)}catch(s){return log.error(_("error.cannot-create-target-directory",n.path)),void e(null)}o.displayDirectory=n.parent,o.defaultString=n.leafName,o.open(function(t){a.activate(),e(t==Ci.nsIFilePicker.returnOK?o.file.path:null)})},downloadMedia:function(){function t(){var t=[];if(r.ignoreSpecs||r.forEach(function(e){var i=new FileUtils.File(e.target);i.exists()&&0==i.fileSize&&t.push(i)}),t.length>0)return log.error(_("empty-downloaded-file",a.hit.data.title)),t.forEach(function(t){t.exists()&&t.remove(!1)}),void e();if(a.hit.data._needsAggregate)a.aggregateMedia();else if(a.hit.data._convert)a.convertMedia();else{simplePrefs.prefs["auto-pin"]&&a.hit.pin();var i=new FileUtils.File(a.hit.data._finalTarget);a.hit.data.localFilePath=a.hit.data._finalLocalFilePath||i.path,a.hit.data.localContainerPath=i.parent.path,a.hit.updateActions(),a.notifyProcessed(),e()}require("./funding").newDownload()}function e(){a.cleanup(),a.hit.setCurrentAction(null),a.notifyRunning(!1)}function i(t){a.hit.setOperation("downloading..."),a.hit.setProgress(t)}var a=this,r=[];this.hit.data._tmpFiles=[];var o=converter.config().license.status;if(this.hit.data._wm="accepted"!=o&&"unneeded"!=o,Cu["import"]("resource://gre/modules/FileUtils.jsm"),this.hit.data.url){if(this.hit.data._downloadTarget=this.hit.data._finalTarget,this.hit.data._convert){var n=this.getTmpFile(this.hit.data.extension,this.hit.data.url);this.hit.data._downloadTarget=n,this.hit.data._tmpFiles.push(n)}r.push({url:this.hit.data.url,target:this.hit.data._downloadTarget,isPrivate:this.hit.data.isPrivate})}else{if(this.hit.data._needsAggregate=!0,this.hit.data.audioUrl)if(this.hit.data.videoUrl)this.hit.data._audioTarget=this.getTmpFile(null,this.hit.data.audioUrl),this.hit.data._tmpFiles.push(this.hit.data._audioTarget),r.push({url:this.hit.data.audioUrl,target:this.hit.data._audioTarget,isPrivate:this.hit.data.isPrivate});else{if(this.hit.data._nowm=1,this.hit.data._needsAggregate=!1,this.hit.data._downloadTarget=this.hit.data._finalTarget,this.hit.data._convert){var n=this.getTmpFile(this.hit.data.extension,this.hit.data.audioUrl);this.hit.data._downloadTarget=n,this.hit.data._tmpFiles.push(n)}r.push({url:this.hit.data.audioUrl,target:this.hit.data._downloadTarget,isPrivate:this.hit.data.isPrivate})}if(this.hit.data.videoUrl)if(this.hit.data.audioUrl)this.hit.data._downloadTarget=this.hit.data._convert?this.getTmpFile(this.hit.data.extension,this.hit.data.videoUrl):this.hit.data._finalTarget,this.hit.data._videoTarget=this.getTmpFile(this.hit.data.extension,this.hit.data.videoUrl),this.hit.data._tmpFiles.push(this.hit.data._videoTarget),r.push({url:this.hit.data.videoUrl,target:this.hit.data._videoTarget,isPrivate:this.hit.data.isPrivate});else{if(this.hit.data._needsAggregate=!1,this.hit.data._downloadTarget=this.hit.data._finalTarget,this.hit.data._convert){var n=this.getTmpFile(this.hit.data.extension,this.hit.data.videoUrl);this.hit.data._downloadTarget=n,this.hit.data._tmpFiles.push(n)}r.push({url:this.hit.data.videoUrl,target:this.hit.data._downloadTarget,isPrivate:this.hit.data.isPrivate})}}r.forEach(function(t){a.hit.data.referrer?t.referrer=a.hit.data.referrer:a.hit.data.pageUrl&&(t.referrer=a.hit.data.pageUrl),a.hit.data.headers&&(t.headers=a.hit.data.headers)}),this.hit.setOperation("queued..."),this.download(r,t,e,i)},aggregateMedia:function(){function t(t,a){r.hit.setOperation("aggregating..."),r.hit.data._convert&&!r.hit.data._convert.audioonly&&(r.hit.data._downloadTarget+=".mkv"),converter.aggregate({audio:r.hit.data._audioTarget,video:r.hit.data._videoTarget,target:r.hit.data._downloadTarget,wm:a,videoCodec:t.videoCodec,fps:t.fps},e,function(t){console.info("failed aggregate",t),i({text:_("failed-aggregating",r.hit.data.title),details:t.details})},function(e){if(t.duration){var i=Math.round(100*e/t.duration);r.hit.setProgress(i)}})}function e(){if(r.hit.data._wm=!1,r.hit.data._convert)r.convertMedia();else{simplePrefs.prefs["auto-pin"]&&r.hit.pin();var t=new FileUtils.File(r.hit.data._finalTarget);r.hit.data.localFilePath=t.path,r.hit.data.localContainerPath=t.parent.path,r.hit.updateActions(),r.notifyProcessed(),r.hit.data._qrTarget&&r.explainQR(),a()}}function i(t){log.error(t),a()}function a(){r.cleanup(),r.hit.setCurrentAction(null),r.notifyRunning(!1)}var r=this;this.hit.data._convert&&this.hit.data._convert.audioonly?(Cu["import"]("resource://gre/modules/osfile.jsm"),OS.File.copy(this.hit.data._audioTarget,this.hit.data._downloadTarget).then(e,i)):converter.info(this.hit.data._videoTarget,function(e){e.duration&&(r.hit.data.duration=e.duration),r.hit.data._wm?converter.wmForHeight(e.height,function(i){i&&i.qr&&(r.hit.data._qrTarget=i.qr,r.hit.data._tmpFiles.push(r.hit.data._qrTarget)),t(e,i)},function(t){console.error("wmForHeight",t),i(_("failed-aggregating",r.hit.data.title))}):t(e,null)},function(t){i({text:_("failed-getting-info",r.hit.data.title),details:t.details})})},convertMedia:function(){function t(t,r){a.hit.setOperation("converting..."),converter.convert({source:a.hit.data._downloadTarget,target:a.hit.data._finalTarget,config:a.hit.data._convert,wm:r},function(){simplePrefs.prefs["auto-pin"]&&a.hit.pin(),Cu["import"]("resource://gre/modules/FileUtils.jsm");var t=new FileUtils.File(a.hit.data._finalTarget);a.hit.data.localFilePath=t.path,a.hit.data.localContainerPath=t.parent.path,a.hit.updateActions(),a.notifyProcessed(),a.hit.data._qrTarget&&a.explainQR(),i()},e,function(e){if(t.duration){var i=Math.round(100*e/t.duration);a.hit.setProgress(i)}})}function e(t){log.error(t),i()}function i(){a.cleanup(),a.hit.setCurrentAction(null),a.notifyRunning(!1)}var a=this;"ready"!=converter.config().status?e(_("converter-requested-unavail")):converter.info(this.hit.data._downloadTarget,function(i){i.width&&i.height&&(a.hit.data.size=i.width+"x"+i.height),i.duration&&(a.hit.data.duration=i.duration),a.hit.data._wm?converter.wmForHeight(i.height,function(e){e&&e.qr&&(a.hit.data._qrTarget=e.qr,a.hit.data._tmpFiles.push(a.hit.data._qrTarget)),t(i,e)},function(){e(_("failed-converting",a.hit.data.title))}):t(i,null)},function(t){e({text:_("failed-getting-info",a.hit.data.title),details:t.details})})},cleanup:function(){!simplePrefs.prefs["converter-keep-tmp-files"]&&this.hit.data._tmpFiles&&this.hit.data._tmpFiles.forEach(function(t){var e=new FileUtils.File(t);e.exists()&&e.remove(!1)}),delete this.hit.data._tmpFiles,delete this.hit.data._needsAggregate,delete this.hit.data._audioTarget,delete this.hit.data._videoTarget,delete this.hit.data._finalTarget,delete this.hit.data._downloadTarget,delete this.hit.data._qrTarget,delete this.hit.data._nowm,delete this.hit.data._convert},getDownloadTargetFilePath:function(t,e){return this.getTargetFilePath(t,e)},abort:function(){this.abortDownload()}}),{actionName:"download",canPerform:function(t){return void 0!==t.data.url||void 0!==t.data.audioUrl||void 0!==t.data.videoUrl||void 0!==t.data.urls},priority:100,title:_("action.download.title"),description:_("action.download.description"),icon:"images/icon-action-download-64.png"}),QuickDownloadAction=merge(Class({"extends":DownloadAction,getDownloadTargetFilePath:function(t,e){e(this.getDefaultTargetFile(t).path)},getDownloadTargetDirPath:function(t,e){var i=null;try{i=this.getDownloadDirectory(),i.append(t),this.createUnique(i,Ci.nsIFile.DIRECTORY_TYPE,493),i.remove(!0)}catch(a){return log.error(_("error.cannot-create-target-directory",i.path)),void e(null)}e(i.path)}}),{actionName:"quickdownload",canPerform:function(t){return void 0!==t.data.url||void 0!==t.data.audioUrl||void 0!==t.data.videoUrl||void 0!==t.data.urls},priority:90,title:_("action.quickdownload.title"),description:_("action.quickdownload.description"),icon:"images/icon-action-quick-download2-64.png"}),ConvertAction=merge(Class({"extends":QuickDownloadAction,start:function(){Cu["import"]("resource://gre/modules/FileUtils.jsm");var t=new FileUtils.File(this.hit.data._downloadTarget),e=t.leafName,i=/^(.*?)\.([^\.]{1,5})$/.exec(e);i&&(e=i[1]),e+="."+this.hit.data.extension,this.hit.data.length=t.fileSize;var a=this;this.getDownloadTargetFilePath(e,function(t){t&&(a.hit.data._finalTarget=t,a.notifyRunning(!0),a.hit.setCurrentAction(a),a.convertMedia())})}}),{actionName:"convert",canPerform:function(t){return t.data.local},priority:90,title:_("action.convert.title"),description:_("action.convert.description"),icon:"images/icon-action-convert-b-64.png"}),DownloadConvertAction=merge(Class({"extends":QuickDownloadAction,start:function(){function t(){function t(){panels.togglePanel("dlconv",{contentURL:"dlconvPanel.html",top:10,closeTimeout:0,jsFiles:["lib/jquery.min.js","lib/bootstrap/bootstrap.min.js","dlconvPanel.js"],onShow:function(t){var a=i.config();t.port.emit("contentMessage",{type:"set",name:"hit",value:e.hit.data}),t.port.emit("contentMessage",{type:"set",name:"formats",value:a.formats}),t.port.emit("contentMessage",{type:"set",name:"codecs",value:a.codecs}),t.port.emit("contentMessage",{type:"set",name:"targets",value:a.targets}),t.port.emit("contentMessage",{type:"set",name:"configs",value:a.configs}),t.port.emit("contentMessage",{type:"set",name:"hasDownloadButton",value:!0}),t.port.emit("contentMessage",{type:"set",name:"hasDownloadConvButton",value:!0}),t.port.emit("contentMessage",{type:"set",name:"panelTitle",value:_("action.downloadconvert.title")}),t.port.emit("contentMessage",{type:"set",name:"transientStorageDirectory",value:transientStorageDirectory}),t.port.emit("contentMessage",{type:"set",name:"renameCheckbox",value:!0})},onMessage:function(a,r){switch(a.type){case"setConfigs":i.setConfigs(a.configs);break;case"resetConfigs":i.resetConfigs(a.configs),r.port.emit("contentMessage",{type:"set",name:"converter",value:i.config()});break;case"showConfigs":i.showConfigs(a.configs);break;case"changeStorageDirectory":e.changeDownloadDirectory(t);break;case"conversionHelp":r.hide(),require("sdk/tabs").open({url:"http://www.downloadhelper.net/conversion-manual3.php"});break;case"download":a.config?e.checkConverter(function(t){if(t){var r=i.config().configs[a.config];r&&(e.hit.data.extension&&(e.hit.data.originalExt=e.hit.data.extension),e.hit.data.extension=r.ext||r.params.f||e.hit.data.extension),e.hit.data._convert=r||null}},_("converter-needed")):(e.hit.data.originalExt&&(e.hit.data.extension=e.hit.data.originalExt),e.hit.data._convert=null),r.hide(),QuickDownloadAction.prototype.start.call(e)}}})}var i=require("./converter");t()}var e=this;!this.hit.data.url&&this.hit.data.audioUrl&&this.hit.data.videoUrl?this.checkConverter(function(i){i&&t.call(e)},_("converter-needed-aggregate"),{text:_("converter-needed-aggregate-why"),url:"http://www.downloadhelper.net/why-converter-needed-aggregation.php"}):this.checkConverter(function(i){i&&t.call(e)})},getDownloadTargetFilePath:function(t,e){simplePrefs.prefs["dlconv-rename"]?DownloadAction.prototype.getDownloadTargetFilePath.call(this,t,e):QuickDownloadAction.prototype.getDownloadTargetFilePath.call(this,t,e)}}),{actionName:"downloadconvert",canPerform:function(t){return void 0!==t.data.url||void 0!==t.data.audioUrl||void 0!==t.data.videoUrl},priority:80,title:_("action.downloadconvert.title"),description:_("action.downloadconvert.description"),icon:"images/icon-action-download-convert-64.png"}),CopyUrlAction=merge(Class({"extends":Action,start:function(){var t=Cc["@mozilla.org/supports-string;1"].createInstance(Ci.nsISupportsString);t.data=this.hit.data.url;var e=Cc["@mozilla.org/widget/transferable;1"].createInstance(Ci.nsITransferable);e.addDataFlavor("text/unicode"),e.setTransferData("text/unicode",t,2*this.hit.data.url.length);var i=Ci.nsIClipboard,a=Cc["@mozilla.org/widget/clipboard;1"].getService(i);a.setData(e,null,i.kGlobalClipboard)}}),{actionName:"copyurl",canPerform:function(t){return void 0!==t.data.url},priority:30,title:_("action.copyurl.title"),description:_("action.copyurl.description"),icon:"images/icon-action-copy-link-64.png"}),BlackListAction=merge(Class({"extends":Action,start:function(){var t=this;panels.togglePanel("blacklist",{top:10,closeTimeout:0,contentURL:"blacklistPanel.html",jsFiles:["lib/jquery.min.js","lib/bootstrap/bootstrap.min.js","blacklistPanel.js"],onShow:function(e){e.port.emit("contentMessage",{type:"set",name:"domains",value:blacklist.domainsFromHit(t.hit.data)})},onMessage:function(t,e){switch(t.type){case"blacklist":e.hide(),blacklist.addToBlacklist(t.blacklist),hits.refresh()}}})}}),{actionName:"blacklist",canPerform:function(t){return void 0!==t.data.url||void 0!==t.data.audioUrl||void 0!==t.data.videoUrl||void 0!==t.data.topUrl||void 0!==t.data.pageUrl},priority:20,title:_("action.blacklist.title"),description:_("action.blacklist.description"),icon:"images/icon-action-blacklist-64.png"}),DetailsAction=merge(Class({"extends":Action,start:function(){var t=this;panels.togglePanel("details",{top:10,closeTimeout:0,contentURL:"detailsPanel.html",jsFiles:"detailsPanel.js",onShow:function(e){e.port.emit("contentMessage",{type:"set",name:"hit",value:t.hit.data})},onMessage:function(t){switch(t.type){case"copy-to-url":var e=Cc["@mozilla.org/supports-string;1"].createInstance(Ci.nsISupportsString);e.data=t.value;var i=Cc["@mozilla.org/widget/transferable;1"].createInstance(Ci.nsITransferable);i.addDataFlavor("text/unicode"),i.setTransferData("text/unicode",e,2*t.value.length);var a=Ci.nsIClipboard,r=Cc["@mozilla.org/widget/clipboard;1"].getService(a);r.setData(i,null,a.kGlobalClipboard)}}})}}),{actionName:"details",canPerform:function(){return!0},priority:0,title:_("action.details.title"),description:_("action.details.description"),icon:"images/icon-action-details-64.png"}),DeleteHitAction=merge(Class({"extends":Action,start:function(){this.hit.remove()}}),{actionName:"deletehit",canPerform:function(){return!0},priority:0,title:_("action.deletehit.title"),description:_("action.deletehit.description"),icon:"images/icon-action-delete-64.png"}),OpenLocalFileAction=merge(Class({"extends":Action,start:function(){Cu["import"]("resource://gre/modules/FileUtils.jsm");var t=new FileUtils.File(this.hit.data.localFilePath);t.launch()}}),{actionName:"openlocalfile",canPerform:function(t){return!!t.data.localFilePath},priority:200,catPriority:1,title:_("action.openlocalfile.title"),description:_("action.openlocalfile.description"),icon:"images/icon-action-play-64.png"}),OpenLocalContainerAction=merge(Class({"extends":Action,start:function(){Cu["import"]("resource://gre/modules/FileUtils.jsm");var t=new FileUtils.File(this.hit.data.localContainerPath);t.launch()}}),{actionName:"openlocalcontainer",canPerform:function(t){return!!t.data.localContainerPath},priority:180,catPriority:1,title:_("action.openlocalcontainer.title"),description:_("action.openlocalcontainer.description"),icon:"images/icon-action-open-dir-64.png"}),PinAction=merge(Class({"extends":Action,start:function(){this.hit.pin()}}),{actionName:"pin",canPerform:function(t){return!t.pinned},priority:0,title:_("action.pin.title"),description:_("action.pin.description"),icon:"images/icon-action-pin-64.png"}),AbortAction=merge(Class({"extends":Action,start:function(){this.hit.currentAction.abort()}}),{actionName:"abort",canPerform:function(t){return!!t.currentAction},priority:300,catPriority:2,title:_("action.abort.title"),description:_("action.abort.description"),icon:"images/icon-action-abort-64.png"}),ScrapRecordAction=merge(Class({"extends":Action,start:function(){require("./scrap").startRecording(this)}}),{actionName:"scraprecord",canPerform:function(t){return t.data.scrapable&&!t.data.scraping&&"started"!=simplePrefs.prefs["scrap.state"]},priority:90,title:_("action.scraprecord.title"),description:_("action.scraprecord.description"),icon:"images/icon-action-record-64.png"}),ScrapSnapshotAction=merge(Class({"extends":Action,start:function(){require("./scrap").takeSnapshot(this)}}),{actionName:"scrapsnapshot",canPerform:function(t){return t.data.scrapable},priority:80,title:_("action.scrapsnapshot.title"),description:_("action.scrapsnapshot.description"),icon:"images/icon-camera-64.png"}),ScrapStopRecordAction=merge(Class({"extends":Action,start:function(){require("./scrap").stopRecording(this)}}),{actionName:"scrapstoprecord",canPerform:function(t){return!!t.data.scraping},priority:110,title:_("action.scrapstoprecord.title"),description:_("action.scrapstoprecord.description"),icon:"images/icon-action-stoprecord-64.png"}),MaskedDownloadAction=merge(Class({"extends":QuickDownloadAction,initialize:function(t){this.masked=!0,this.aborted=!1,QuickDownloadAction.prototype.initialize.call(this,t)},getDownloadTargetFilePath:function(t,e){this.hit.data.originalFilename=t,t=utils.md5(this.hit.data.url)+".bin",QuickDownloadAction.prototype.getDownloadTargetFilePath.call(this,t,e)},abort:function(){this.aborted=!0,this.abortNotified=!1,this.hit&&this.hit.abortFn&&this.hit.abortFn()},initiateDownload:function(t,e,i,a){var r=this,o=masked.makeFileNames(t.target.path||t.target);masked.File.open(o.binFilePath,{write:!0,append:!1,key:this.cryptoKey,iv:this.biniv}).then(function(n){function s(){if(l&&!d){if(0==c.length)return void(h&&(n.close(),masked.finalize(r,o.manifestFilePath,function(t){r.hit.data._finalLocalFilePath=o.manifestFilePath,t?i(t):e()})));var t=c.shift();d=!0,n.write(t).then(function(){d=!1,s()},function(t){l=!1,n.close(),i(t)})}}var c=[],l=!0,d=!1,h=!1,p=-1;r.hit.updateActions(),masked.MaskedDownload(t.source.url||t.source,t.target.referrer||null,function(t,e,o,n){return n!=p&&(p=n,a(n)),r.aborted?(r.abortNotified||(r.abortNotified=!0,i(new Error("User canceled"))),!1):l?(t?(i(t),l=!1):(h=o,e&&c.push(e),s()),l):!1})},function(t){i(t)})}}),{actionName:"maskeddownload",canPerform:function(t){return simplePrefs.prefs["masked.enabled"]&&void 0!==t.data.url},priority:70,title:_("action.maskeddownload.title"),description:_("action.maskeddownload.description"),icon:"images/icon-action-masked-download-64.png"}),actionClasses={download:DownloadAction,quickdownload:QuickDownloadAction,downloadconvert:DownloadConvertAction,copyurl:CopyUrlAction,blacklist:BlackListAction,details:DetailsAction,deletehit:DeleteHitAction,openlocalfile:OpenLocalFileAction,openlocalcontainer:OpenLocalContainerAction,pin:PinAction,abort:AbortAction,convert:ConvertAction,scraprecord:ScrapRecordAction,scrapstoprecord:ScrapStopRecordAction,scrapsnapshot:ScrapSnapshotAction,maskeddownload:MaskedDownloadAction};exports.perform=function(t,e){var i=actionClasses[t];if(i){var a=new i(e);a.start()}},exports.availableActions=function(t){var e=[];for(var i in actionClasses){var a=actionClasses[i];a.canPerform(t)&&e.push(i)}var r=[simplePrefs.prefs["default-action-0"],simplePrefs.prefs["default-action-1"],simplePrefs.prefs["default-action-2"]];return e.sort(function(t,e){var i=actionClasses[t],a=actionClasses[e],o=i.catPriority||0,n=a.catPriority||0;return n!=o?n-o:t==r[o]?-1:e==r[n]?1:a.priority-i.priority}),e},exports.describeActions=function(){var t={};for(var e in actionClasses){var i=actionClasses[e];t[e]={title:i.title,description:i.description,icon:i.icon,icon18:i.icon.replace("-64.png","-18.png"),catPriority:i.catPriority||0}}return t},exports.getBrowserDownloadLastDir=function(){try{return Cc["@mozilla.org/preferences-service;1"].getService(Ci.nsIPrefService).getBranch("browser.download.").getCharPref("lastDir")}catch(t){return null}},exports.getDownloadDirectory=function(t){var e=null;simplePrefs.prefs["storage-last-dir"]&&(e=exports.getBrowserDownloadLastDir()),e||(e=transientStorageDirectory||simplePrefs.prefs.storagedirectory);var i;if(null==e||0==e.length)i=exports.getDefaultDir();else try{i=Cc["@mozilla.org/file/local;1"].createInstance(Ci.nsILocalFile),i.initWithPath(e);var a=null;0==i.exists()?a=_("storage-directory-not-exist",e):0==i.isWritable()?a=_("storage-directory-not-writable",e):0==i.isDirectory()&&(a=_("storage-directory-not-directory",e)),a&&(i=exports.getDefaultDir(),log.log(_("force-default-storage-directory",a,i.path)))}catch(r){i=exports.getDefaultDir(),log.log("storage-directory-error",""+r,i.path)}return i.exists()||i.create(Ci.nsIFile.DIRECTORY_TYPE,493),transientStorageDirectory=i.path,t||(simplePrefs.prefs.storagedirectory=i.path),i},exports.getDefaultDir=function(){var t=null;if(simplePrefs.prefs["storage-last-dir"])try{var e=exports.getBrowserDownloadLastDir();if(e)return Cu["import"]("resource://gre/modules/FileUtils.jsm"),t=new FileUtils.File(e)}catch(i){}try{t=Cc["@mozilla.org/file/directory_service;1"].getService(Ci.nsIProperties).get("Home",Ci.nsIFile)}catch(i){try{t=Cc["@mozilla.org/file/directory_service;1"].getService(Ci.nsIProperties).get("TmpD",Ci.nsIFile)}catch(i){}}if(!t.exists())throw _("error.nohome");return t.append("dwhelper"),t},exports.changeStorageDirectory=function(t,e){var i=Cc["@mozilla.org/appshell/window-mediator;1"].getService(Ci.nsIWindowMediator),a=i.getMostRecentWindow("navigator:browser"),r=require("sdk/windows").browserWindows.activeWindow,o=Cc["@mozilla.org/filepicker;1"].createInstance(Ci.nsIFilePicker);o.init(a,_("prompt.select-storage-dir"),Ci.nsIFilePicker.modeGetFolder);var n=null;try{n=Cc["@mozilla.org/file/local;1"].createInstance(Ci.nsILocalFile),n.initWithPath(simplePrefs.prefs.storagedirectory),n.exists()&&n.isWritable()&&n.isDirectory()||(n=exports.getDefaultDir())}catch(s){}n&&(o.displayDirectory=n.parent,o.defaultString=n.leafName),o.open(function(i){r.activate(),i==Ci.nsIFilePicker.returnOK&&(transientStorageDirectory=o.file.path,t||(simplePrefs.prefs.storagedirectory=o.file.path)),e&&e()})},exports.Action=Action,exports.actionClasses=actionClasses,exports.registerAction=function(t,e){actionClasses[t]=e},exports.unregisterAction=function(t){delete actionClasses[t]},exports.transientStorageDirectory=function(){return transientStorageDirectory};