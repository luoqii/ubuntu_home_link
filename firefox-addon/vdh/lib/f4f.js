/* Copyright (C) 2006-2016 Michel Gutierrez <mig@downloadhelper.net>
 * All Rights Reserved
 * 
 * If you are interested in methods used in this project, follow the
 * open source project at https://github.com/mi-g/fang
 */

const $chrome=require("chrome"),Cc=$chrome.Cc,Ci=$chrome.Ci,Cu=$chrome.Cu,$osfile=Cu["import"]("resource://gre/modules/osfile.jsm",{}),OS=$osfile.OS,Class=require("sdk/core/heritage").Class,_=require("sdk/l10n").get,simplePrefs=require("sdk/simple-prefs"),chunkset=require("./chunkset"),Chunkset=chunkset.Chunkset,bits=require("./bits"),mp4f=require("./mp4f"),utils=require("./utils"),amf=require("./amf"),masked=require("./masked");exports.F4fChunkset=Class({"extends":Chunkset,init:function(e){Chunkset.prototype.init.call(this,e),e.descrPrefix=_("f4f-streaming"),this.stopDownloadingOnChunkError=!0,this.startFrag=e.startFrag,this.postFrag=e.postFrag},download:function(e,t,s,i,n){var r=this;this.aborted=!1,this.action=e,this.specs=t,this.successFn=s,this.errorFn=i,this.progressFn=n,this.downloadTarget=e.hit.data._downloadTarget,this.chunks=[],this.processedSegmentsCount=0,this.dataSize=0,e.hit.updateActions(),this.masked=!!e.masked,this.masked&&(this.biniv=e.biniv,this.cryptoKey=e.cryptoKey),this.openFile(function(e){if(e)return i(e);var t=new Uint8Array([70,76,86,1,5,0,0,0,9,0,0,0,0]);r.file.write(t).then(function(){r.fetchChunks(),r.recording=!0,r.handle()},function(e){i(e)})}),e.hit.abortFn=function(){r.actionAbortFn(r.downloadTarget)}},processChunk:function(e,t){var s=this;e.processing=!0,s.processChunkData(e.data,function(i,n){if(i)return t.call(s,i,e);var r=n.length;s.file.write(n).then(function(){if(s.processedSegmentsCount++,s.dataSize+=r,s.processedSegmentsCount>=s.chunks.length)s.recording&&(s.recording=!1,s.finalize(null));else if(s.progressFn&&!s.aborted){var i;i=s.action.hit.data.length?Math.min(Math.round(100*s.dataSize/s.action.hit.data.length),100):Math.round(100*s.processedSegmentsCount/(s.segmentsCount||s.chunks.length||1)),i!=s.lastProgress&&s.progressFn(i),s.lastProgress=i}s.fetchChunks(),t.call(s,null,e)},function(i){t.call(s,i,e)})})},processChunkData:function(e,t){for(var s=mp4f.getTags("mdat",e),i=[],n=0;n<s.length;n++)i.push(s[n].data);var r=mp4f.flatten(i);t.call(this,null,r)},fetchChunks:function(){if(!this.noMoreChunkToDownload){Cu["import"]("resource://gre/modules/NetUtil.jsm");for(var e=this.action.hit.data,t=NetUtil.newURI(e.url);this.chunks.length-this.lastProcedIndex<=simplePrefs.prefs["chunks.prefetch-count"];){var s;s=t.resolve(simplePrefs.prefs["f4f.frag-index"]?e._media.urlHint+"Seg1-Frag"+(this.chunks.length+this.startFrag):e._media.urlHint+"Seg1-Frag"+(this.chunks.length+1)),simplePrefs.prefs["f4f.frag-post-url"]&&(s+=this.postFrag),this.chunks.push({url:s,index:this.chunks.length})}}},openFile:function(e){var t=this,s=(this.action,OS),i={write:!0,truncate:!0};this.masked&&(s=masked,i.iv=this.biniv,i.key=this.cryptoKey),s.File.open(this.downloadTarget,i).then(function(s){t.file=s,e(null)},function(t){e(t)})},finalize:function(e,t){var s=this;if(this.file&&(this.file.close(),delete this.file),this.masked&&!e){var i=masked.makeFileNames(this.downloadTarget);masked.finalize(this.action,i.manifestFilePath,function(e){s.action.hit.data._finalLocalFilePath=i.manifestFilePath,Chunkset.prototype.finalize.call(s,e,t)})}else Chunkset.prototype.finalize.call(this,e,t)}});