/* Copyright (C) 2006-2016 Michel Gutierrez <mig@downloadhelper.net>
 * All Rights Reserved
 * 
 * If you are interested in methods used in this project, follow the
 * open source project at https://github.com/mi-g/fang
 */

function DecodeVideoData(e){var t={videoId:e.videoId,title:e.data.title||_("video"),topUrl:e.topUrl,from:"tfvws"};e.data.duration&&(t.duration=e.data.duration);var i=[];for(var r in e.data.qualities)"auto"!=r&&e.data.qualities[r].forEach(function(e,t){var o="mp4",s=/\/(.*)/.exec(e.type);s&&(o=s[1]);var a;s=/cdn\/[^\/]*?([0-9]+x[0-9]+)\//.exec(e.url),s&&(a=s[1]),i.push({itag:r+"-"+t,url:e.url,size:a})});var o=variants.getHitsFromVariants(t,i);o.forEach(function(e){listeners.forEach(function(t){t(e)})})}function GetVideoMeta(e){simplePrefs.prefs["write-video-data-file"]&&utils.saveStringToFile("tfvws-"+e.videoId+".json",JSON.stringify(e,null,4)),DecodeVideoData(e)}function UpdateDetection(){var e=simplePrefs.prefs["tfvws.enabled"];e&&!tfvwsPageMod?tfvwsPageMod=pageMod.PageMod({include:PM_PATTERN,contentScriptFile:self.data.url("tfvws-content.js"),contentScriptWhen:"end",attachTo:["existing","top","frame"],onAttach:function(e){e.port.on("detected-video",function(t){t.hasVideo&&(t.topUrl=e.tab.url,t.isPrivate=privateBrowsing.isPrivate(e),GetVideoMeta(t))})}}):!e&&tfvwsPageMod&&(tfvwsPageMod.destroy(),tfvwsPageMod=null)}const self=require("sdk/self"),$chrome=require("chrome"),Cc=$chrome.Cc,Ci=$chrome.Ci,Cu=$chrome.Cu,pageMod=require("sdk/page-mod"),privateBrowsing=require("sdk/private-browsing"),Request=require("sdk/request").Request,simplePrefs=require("sdk/simple-prefs"),merge=require("sdk/util/object").merge,_=require("sdk/l10n").get,variants=require("./variants"),utils=require("./utils");var OS=null,encoder=null,listeners=[];const PARAM_PATTERN=new RegExp("^(.*?)=(.*)$"),TYPE_PATTERN=new RegExp("^([^/;]+)/(?:x-)?([^/;]+)"),PM_PATTERN=new RegExp("^https?://([^/]*.)?dailymotion(.co)?.([^./]+)/.*");var tfvwsPageMod=null;UpdateDetection(),simplePrefs.on("tfvws.enabled",UpdateDetection),exports.addListener=function(e){listeners.push(e)},exports.removeListener=function(e){var t=listeners.indexOf(e);t>=0&&listeners.splice(t,1)};